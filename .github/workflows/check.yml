name: Deploy to Server

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.1.7

      - name: Set up Node.js
        uses: actions/setup-node@v4.0.3
        with:
          node-version: '20.x'

      - name: Install Dependencies
        run: npm install

      - name: Deploy to Server via SSH with password
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}  
          username: ${{ secrets.SERVER_USER }} 
          password: ${{ secrets.SERVER_PASSWORD }} 
          port: 22  # Cổng SSH (mặc định là 22)
          script: |
            cd api/quickmem-server  
            git pull origin main  # Pull code mới
            bun install  # Cài đặt lại dependencies nếu cần
            bun run build  # Build dự án
            pm2 restart quickmem-server  # Restart server với PM2

      - name: Send Telegram Notification on Success
        uses: appleboy/telegram-action@master
        if: success()
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            <b>QuickMem Server Deployed Successfully</b>
            <b>Repository</b>: ${{ github.repository }}
            <b>Committer</b>: ${{ github.actor }}
            <b>Commit Message</b>: ${{ github.event.head_commit.message }}
            <b>Branch</b>: ${{ github.ref_name }}
            <b>Changes</b>: <a href="https://github.com/pass-with-high-score/quickmem-server/commit/${{github.sha}}">View Changes</a>
            <b>Action</b>: <a href="https://github.com/pass-with-high-score/quickmem-server/actions/runs/${{ github.run_id }}">View Action</a>

      - name: Send Telegram Notification on Failure
        uses: appleboy/telegram-action@master
        if: failure()
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          format: html
          message: |
            <b>QuickMem Server Deployment Failed</b>
            <b>Repository</b>: ${{ github.repository }}
            <b>Committer</b>: ${{ github.actor }}
            <b>Commit Message</b>: ${{ github.event.head_commit.message }}
            <b>Branch</b>: ${{ github.ref_name }}
            <b>Changes</b>: <a href="https://github.com/pass-with-high-score/quickmem-server/commit/${{github.sha}}">View Changes</a>
            <b>Action</b>: <a href="https://github.com/pass-with-high-score/quickmem-server/actions/runs/${{ github.run_id }}">View Action</a>
